<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> DTC - Chennai </title>
<style>
  body { font-family: Arial; margin: 20px; background: #f4f6f8; }
  .container { max-width: 1400px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
  h1 { text-align: center; margin-bottom: 20px; }
  .filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  select, button { padding: 6px; font-size: 14px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 8px; text-align: left; }
  th { background-color: #007bff; color: white; }
  tbody tr:nth-child(even) { background: #f9f9f9; }
  .grand-total { font-weight: bold; background-color: #e0e0e0; }
</style>
</head>
<body>
<div class="container">
  <h1>Chennai VFirst Trail Report</h1>
  <input type="file" id="excelFile" accept=".xlsx,.xls">
  <div class="filters">
    <select id="callerFilter"><option value="">All CallerId</option></select>
    <select id="siteFilter"><option value="">All SiteName</option></select>
    <select id="brandFilter"><option value="">All BrandName</option></select>
    <select id="subBrandFilter"><option value="">All SubBrandName</option></select>
    <select id="trialFilter"><option value="">All TrialStatus</option></select>
    <select id="chasisFilter"><option value="">All ChasisName</option></select>
    <select id="tcCodeFilter"><option value="">All TCCode</option></select>
    <select id="agencyFilter"><option value="">All AgencyName</option></select>
    <button onclick="applyFilters()">Apply Filters</button>
    <button onclick="clearFilters()">Clear All Filters</button>
    <button onclick="viewDashboard()">View Grand Total Dashboard</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>CallerId</th>
        <th>SiteName</th>
        <th>BrandName</th>
        <th>SubBrandName</th>
        <th>TrialStatus</th>
        <th>ChasisName</th>
        <th>TCCode</th>
        <th>AgencyName</th>
        <th>Total Trails</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let excelData = [];
let currentSubBrandTotals = {};

document.getElementById('excelFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = (evt)=>{
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    excelData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

    populateFilters();
    setDefaultSite();
    applyFilters(); 
  };
  reader.readAsArrayBuffer(file);
});

function populateFilters(){
  const fields = {
    'callerFilter':'CallerId',
    'siteFilter':'SiteName',
    'brandFilter':'BrandName',
    'subBrandFilter':'SubBrandName',
    'trialFilter':'TrialStatus',
    'chasisFilter':'ChasisName',
    'tcCodeFilter':'TCCode',
    'agencyFilter':'AgencyName'
  };
  for(const [selectId,col] of Object.entries(fields)){
    const set = new Set();
    excelData.forEach(r=>{ if(r[col]) set.add(r[col]); });
    const select = document.getElementById(selectId);
    select.innerHTML = `<option value="">All ${col}</option>`;
    Array.from(set).sort().forEach(v=>{
      const opt = document.createElement('option'); opt.value=v; opt.text=v;
      select.appendChild(opt);
    });
  }
}

function setDefaultSite(){
  const siteSelect = document.getElementById('siteFilter');
  if([...siteSelect.options].some(o=>o.value==='Chennai')) siteSelect.value='Chennai';
}

function applyFilters(){
  const filters = {
    'CallerId': document.getElementById('callerFilter').value,
    'SiteName': document.getElementById('siteFilter').value,
    'BrandName': document.getElementById('brandFilter').value,
    'SubBrandName': document.getElementById('subBrandFilter').value,
    'TrialStatus': document.getElementById('trialFilter').value,
    'ChasisName': document.getElementById('chasisFilter').value,
    'TCCode': document.getElementById('tcCodeFilter').value,
    'AgencyName': document.getElementById('agencyFilter').value
  };

  const filtered = excelData.filter(r=>{
    return Object.keys(filters).every(f=>!filters[f] || r[f] === filters[f]);
  });

  renderReport(filtered);
}

function renderReport(data){
  const tbody = document.getElementById('reportBody');
  tbody.innerHTML = "";

  const grouped = {};
  const subBrandTotals = {};

  data.forEach(r=>{
    const key = `${r.CallerId}_${r.SiteName}_${r.BrandName}_${r.SubBrandName}_${r.TrialStatus}_${r.ChasisName}_${r.TCCode}_${r.AgencyName}`;
    if(!grouped[key]) grouped[key] = {...r, Trails:0};
    grouped[key].Trails +=1;

    if(!subBrandTotals[r.SubBrandName]) subBrandTotals[r.SubBrandName] = 0;
    subBrandTotals[r.SubBrandName] += 1;
  });

  currentSubBrandTotals = subBrandTotals; 

  const rows = Object.values(grouped);
  const batchSize = 50;
  let i=0;

  function renderBatch(){
    const fragment = document.createDocumentFragment();
    for(let j=0;j<batchSize && i<rows.length;j++,i++){
      const r = rows[i];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.CallerId}</td>
        <td>${r.SiteName}</td>
        <td>${r.BrandName}</td>
        <td>${r.SubBrandName}</td>
        <td>${r.TrialStatus}</td>
        <td>${r.ChasisName}</td>
        <td>${r.TCCode}</td>
        <td>${r.AgencyName}</td>
        <td>${r.Trails}</td>
      `;
      fragment.appendChild(tr);
    }
    tbody.appendChild(fragment);

    if(i<rows.length){
      requestAnimationFrame(renderBatch);
    }
  }

  requestAnimationFrame(renderBatch);
}

function clearFilters(){
  const filterIds = ['callerFilter','siteFilter','brandFilter','subBrandFilter','trialFilter','chasisFilter','tcCodeFilter','agencyFilter'];
  filterIds.forEach(id => {
    document.getElementById(id).value = "";
  });
  setDefaultSite(); // Reset Site to Chennai
  applyFilters();
}

function viewDashboard(){
  const dashboardWindow = window.open("", "_blank", "width=800,height=600,scrollbars=yes");
  dashboardWindow.document.write(`<html><head><title>Grand Total Dashboard</title>
  <style>
    body { font-family: Arial; margin: 20px; background: #f4f6f8; }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #007bff; color: white; }
    tbody tr:nth-child(even) { background: #f9f9f9; }
  </style>
  </head><body>
  <h2>Chennai VFirst Grand Total Dashboard</h2>
  <table>
    <thead><tr><th>SubBrandName</th><th>Total Trails</th></tr></thead>
    <tbody>
      ${Object.entries(currentSubBrandTotals).map(([subBrand,total])=>`<tr><td>${subBrand}</td><td>${total}</td></tr>`).join('')}
    </tbody>
  </table>
  </body></html>`);
  dashboardWindow.document.close();
}
</script>
</body>
</html>
